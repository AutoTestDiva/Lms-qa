  name:  Java CI with Gradle [UBUNTU]
  on:
     schedule:
        # Запуск каждый день в 7:00 утра
        - cron: '0 7 * * *'
     workflow_dispatch:
      # Позволяет запускать workflow вручную

     push:
      branches: [ main ]
     pull_request:
      branches: [ main ]
  jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Set up JDK 15
          uses: actions/setup-java@v4
          with:
            distribution: 'adopt'
            java-version: '15'

        - name: Check Java version
          run: java -version

        - name: Grant execute permission for gradlew
          run: chmod +x gradlew

        - name: Install dependencies
          run: sudo apt-get install -y xvfb x11-utils

        - name: Start Xvfb
          run: Xvfb :99 -screen 0 1920x1080x24 &
          env:
              DISPLAY: :99

        - name: Verify Xvfb
          run: xdpyinfo | grep dimensions
          env:
              DISPLAY: :99

        - name: Get application.yml from secrets and decode it
          run: |
              echo "${{ secrets.DB_URL }}"  >> ./src/test/resources/application.yml
              echo "${{ secrets.DB_USER_NAME }}"  >> ./src/test/resources/application.yml
              echo "${{ secrets.DB_PASSWORD }}"  >> ./src/test/resources/application.yml

        - name: Build with Gradle
          run: ./gradlew clean qa -Psuite4
          env:
              DISPLAY: :99

        - name: List files in test reports directory
          run: ls -la build/reports/tests/qa

        - name: Upload test reports
          uses: actions/upload-artifact@v2
          with:
             name: test-reports
             path: build/reports/tests/qa

        - name: Check if log file exists and has content
          run: |
            if [ ! -s build/reports/tests/qa/result4.log ]; then
              echo "Log file is empty or does not exist" >&2
              exit 1
            fi

        - name: Gather test results
          id: test-result
          run: |
            if [ -f build/reports/tests/qa/result4.log ]; then
              summary=$(awk '{print "<tr><td style=\"border: 1px solid black; padding: 8px;\">" $1 "</td><td style=\"border: 1px solid black; padding: 8px;\">" $2 "</td></tr>"}' build/reports/tests/qa/result4.log)
              echo "::set-output name=summary::$summary"
            else
              echo "::set-output name=summary::<tr><td style=\"border: 1px solid black; padding: 8px;\">No tests</td><td style=\"border: 1px solid black; padding: 8px;\">No results</td></tr>"
            fi

        - name: Archive test reports
          if: always()
          uses: actions/upload-artifact@v2
          with:
             name: test-reports
             path: build/reports/tests/qa

        - name: Send email notification
          if: always()
          uses: dawidd6/action-send-mail@v3
          with:
                  server_address: smtp.gmail.com
                  server_port: 587
                  username: ${{ secrets.EMAIL_USERNAME }}
                  password: ${{ secrets.EMAIL_PASSWORD }}
                  subject: GitHub Actions - Test Report
                  to: pnata1978@gmail.com
                  from: ${{ secrets.EMAIL_USERNAME }}
                  content_type: text/html
                  body: |
                    <h1>Test Results</h1>
                    <p>Here are the test results:</p>
                    <p>Status: ${{ job.status }}</p>
                    <h2>Test Summary:</h2>
                    <table style="border: 1px solid black; border-collapse: collapse;">
                      <tr>
                        <th style="border: 1px solid black; padding: 8px;">Test</th>
                        <th style="border: 1px solid black; padding: 8px;">Result</th>
                      </tr>
                      ${{ steps.test-result.outputs.summary }}
                    </table>
                    <p>Check the attached test reports for more details.</p>
          attachments: build/reports/tests/qa/index.html

        - name: Deploy
          run: echo 'Deploying...'