  name:  Java CI with Gradle [UBUNTU]
  on:
    push:
      branches: [ main ]
    pull_request:
      branches: [ main ]
  jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Set up JDK 15
          uses: actions/setup-java@v4
          with:
            distribution: 'adopt'
            java-version: '15'

        - name: Check Java version
          run: java -version

        - name: Grant execute permission for gradlew
          run: chmod +x gradlew

        - name: Install dependencies
          run: sudo apt-get install -y xvfb x11-utils

        - name: Start Xvfb
          run: Xvfb :99 -screen 0 1920x1080x24 &
          env:
              DISPLAY: :99

        - name: Verify Xvfb
          run: xdpyinfo | grep dimensions
          env:
              DISPLAY: :99

        - name: Get application.yml from secrets and decode it
          run: |
              echo "${{ secrets.DB_URL }}"  >> ./src/test/resources/application.yml
              echo "${{ secrets.DB_USER_NAME }}"  >> ./src/test/resources/application.yml
              echo "${{ secrets.DB_PASSWORD }}"  >> ./src/test/resources/application.yml

        - name: Build with Gradle
          run: ./gradlew clean qa -Psuite4
          env:
              DISPLAY: :99

        - name: Upload test reports
          uses: actions/upload-artifact@v2
          with:
            name: test-reports
            path: /home/runner/work/Lms-qa/Lms-qa/build/reports/tests/qa

#        - name: Check if log file exists and has content
#          run: |
#            if [ ! -s result4.log ]; then
#                   echo "Log file is empty or does not exist" >&2
#                   exit 1
#            fi


        - name: Upload test report
          if: always()
          uses: actions/upload-artifact@v3
          with:
            name: test-report
#            path: result4.log



        #        - name: Check if log file exists and has content
#          run: |
#            if [ ! -s build.log ]; then
#              echo "Log file is empty or does not exist" >&2
#              exit 1
#            fi
#
#        - name: Upload test report
#          if: always()
#          uses: actions/upload-artifact@v3
#          with:
#            name: build-log
#            path: build.log


        #        - name: Upload test reports
#          uses: actions/upload-artifact@v4
#          if: always()
#          with:
#            name: test-reports
#            path: build/reports/tests/test

        - name: Deploy
          run: echo 'Deploying...'